name: Test Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-backend:
    name: Ð—Ð°Ð¿ÑƒÑÐº Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Backend
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: boxing_user
          POSTGRES_PASSWORD: boxing_password
          POSTGRES_DB: boxing_game
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Create .env file
        working-directory: ./backend
        run: |
          cat > .env << EOF
          NODE_ENV=development
          PORT=3000
          API_PREFIX=api/v1
          DB_HOST=localhost
          DB_PORT=5432
          DB_USERNAME=boxing_user
          DB_PASSWORD=boxing_password
          DB_DATABASE=boxing_game
          REDIS_HOST=localhost
          REDIS_PORT=6379
          JWT_SECRET=test-secret-key-for-ci
          JWT_EXPIRATION=7d
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBAPP_URL=https://test.com
          ENERGY_REGEN_INTERVAL=60000
          OFFLINE_INCOME_LIMIT=28800000
          MAX_ENERGY=10
          THROTTLE_TTL=60
          THROTTLE_LIMIT=100
          EOF
      
      - name: Run migrations
        working-directory: ./backend
        run: npm run migration:run || echo "No migrations to run"
      
      - name: Start backend server
        working-directory: ./backend
        run: |
          npm run start:dev &
          echo "Waiting for server to start..."
          sleep 30
      
      - name: Test Health Check
        run: |
          echo "Testing health endpoint..."
          curl -f http://localhost:3000/api/v1/health || exit 1
          echo "âœ… Health check passed!"
      
      - name: Test Database Connection
        run: |
          echo "Testing database connection..."
          curl -f http://localhost:3000/api/v1/health/db || exit 1
          echo "âœ… Database connection passed!"
      
      - name: Test Swagger Documentation
        run: |
          echo "Testing Swagger docs..."
          curl -f http://localhost:3000/api/docs || exit 1
          echo "âœ… Swagger docs accessible!"
      
      - name: Display Success Message
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ‰ BACKEND Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐŸÐ£Ð©Ð•Ð Ð˜ Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 3000"
          echo "âœ… Health check Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
          echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°"
          echo "âœ… API Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°"
          echo ""
          echo "ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±ÐµÐ½!"

  test-frontend:
    name: Ð—Ð°Ð¿ÑƒÑÐº Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_BACKEND_URL: http://localhost:3000
          VITE_WS_URL: ws://localhost:3000
        run: npm run build
      
      - name: Check build output
        working-directory: ./frontend
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Frontend build successful!"
            ls -la dist/
          else
            echo "âŒ Frontend build failed!"
            exit 1
          fi
      
      - name: Display Success Message
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ‰ FRONTEND Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð¡ÐžÐ‘Ð ÐÐ!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
          echo "âœ… Build Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
          echo "âœ… Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹"

  deployment-summary:
    name: Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: always()
    
    steps:
      - name: Generate Report
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š ÐžÐ¢Ð§ÐÐ¢ Ðž Ð—ÐÐŸÐ£Ð¡ÐšÐ• ÐŸÐ ÐžÐ•ÐšÐ¢Ð BOXING CHAMPION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Backend Status:  ${{ needs.test-backend.result }}"
          echo "Frontend Status: ${{ needs.test-frontend.result }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "${{ needs.test-backend.result }}" == "success" ] && [ "${{ needs.test-frontend.result }}" == "success" ]; then
            echo "âœ… Ð’Ð¡Ð• ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢Ð« Ð ÐÐ‘ÐžÐ¢ÐÐ®Ð¢ ÐšÐžÐ Ð Ð•ÐšÐ¢ÐÐž!"
            echo ""
            echo "ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð² GitHub Actions!"
            echo "Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹."
            echo ""
            echo "ðŸš€ ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ!"
          else
            echo "âš ï¸ ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ"
            echo ""
            echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð²Ñ‹ÑˆÐµ Ð´Ð»Ñ ÑƒÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼."
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
